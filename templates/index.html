<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Customer Enquiry Detection System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="static/style.css" rel="stylesheet">
 
</head>
<body>
    <div class="gradient-bg">
        <!-- Floating Bubbles -->
        <div id="bubbles-container"></div>

        <!-- Header -->
        <div class="glass-effect relative z-10" style="border-bottom: 1px solid rgba(255, 255, 255, 0.3);">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3 slide-up-animation">
                        <div class="bg-white bg-opacity-20 p-3 rounded-xl backdrop-blur-lg border border-white border-opacity-30">
                            <svg class="icon text-white" style="width: 28px; height: 28px;">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <h1 class="text-3xl font-bold text-white" style="text-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                            AI Enquiry Detection
                        </h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <svg class="icon text-white cursor-pointer hover:scale-110 transition-transform">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="bg-white bg-opacity-20 backdrop-blur-lg text-white px-5 py-2 rounded-full text-sm font-bold border border-white border-opacity-30 glow-card">
                            LIVE
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-6 relative z-10">
            <!-- Tabs -->
            <div class="mt-6 flex space-x-3 glass-effect rounded-2xl p-2">
    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-button active flex-1 py-3 px-6 rounded-xl font-semibold">
        Dashboard
    </button>
    <button onclick="switchTab('enquiries')" id="tab-enquiries" class="tab-button flex-1 py-3 px-6 rounded-xl font-semibold">
        Live Enquiries
    </button>
    <button onclick="switchTab('chatbot')" id="tab-chatbot" class="tab-button flex-1 py-3 px-6 rounded-xl font-semibold">
        AI Chatbot
    </button>
</div>


            <!-- Tab Content -->
            <div class="py-6">
                <!-- Dashboard Tab -->
                <div id="content-dashboard" class="tab-content">
                    <div class="space-y-6">
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                           <div class="glass-effect rounded-2xl p-6 glow-card slide-up-animation">
    <div class="flex items-center justify-between">
        <div>
            <p class="text-white text-opacity-80 text-sm font-medium">Total Enquiries</p>
            <p class="text-5xl font-bold text-white mt-2" id="stat-total">
                {{ total_enquiries }}
            </p>
        </div>
        <div class="bg-white bg-opacity-20 p-4 rounded-xl">
            <svg class="icon text-white" style="width: 32px; height: 32px;">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        </div>
    </div>
</div>


                            <div class="glass-effect rounded-2xl p-6 glow-card slide-up-animation" style="animation-delay: 0.1s;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white text-opacity-80 text-sm font-medium">Matched Products</p>
                                        <p class="text-5xl font-bold text-white mt-2" id="stat-matched">198</p>
                                    </div>
                                    <div class="bg-white bg-opacity-20 p-4 rounded-xl">
                                        <svg class="icon text-white" style="width: 32px; height: 32px;">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-effect rounded-2xl p-6 glow-card slide-up-animation" style="animation-delay: 0.2s;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white text-opacity-80 text-sm font-medium">Auto Responses</p>
                                        <p class="text-5xl font-bold text-white mt-2" id="stat-responded">186</p>
                                    </div>
                                    <div class="bg-white bg-opacity-20 p-4 rounded-xl">
                                        <svg class="icon text-white" style="width: 32px; height: 32px;">
                                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-effect rounded-2xl p-6 glow-card slide-up-animation" style="animation-delay: 0.3s;">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white text-opacity-80 text-sm font-medium">Conversions</p>
                                        <p class="text-5xl font-bold text-white mt-2" id="stat-conversions">42</p>
                                    </div>
                                    <div class="bg-white bg-opacity-20 p-4 rounded-xl">
                                        <svg class="icon text-white" style="width: 32px; height: 32px;">
                                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Platform Stats -->
                        <div class="glass-effect rounded-2xl p-6 slide-up-animation" style="animation-delay: 0.4s;">
                            <h2 class="text-2xl font-bold text-white mb-6">Multi-Platform Integration</h2>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="platform-stats">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enquiries Tab -->
                <div id="content-enquiries" class="tab-content hidden">
                    <div class="glass-effect rounded-2xl p-6 slide-up-animation">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">Live Enquiries Monitor</h2>
                            <button onclick="toggleAddForm()" id="add-enquiry-btn" class="bg-white text-purple-700 px-5 py-2 rounded-xl font-semibold hover:bg-opacity-90 transition-all flex items-center space-x-2 shadow-lg">
                                <svg class="icon" style="width: 18px; height: 18px;">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                <span>Add Enquiry</span>
                            </button>
                        </div>

                        <!-- Add Form -->
                        <div id="add-form" class="hidden bg-white bg-opacity-10 backdrop-blur-lg border border-white border-opacity-20 rounded-xl p-5 mb-6">
                            <p class="text-white font-semibold mb-4">New Enquiry</p>
                            <select id="new-platform" class="w-full mb-4 px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50">
                                <option value="Twitter">Twitter</option>
                                <option value="Google Ads">Google Ads</option>
                                <option value="Facebook">Facebook</option>
                                <option value="Alexa">Alexa</option>
                            </select>
                            <input type="text" id="new-query" placeholder="Enter customer query..." class="w-full mb-4 px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 text-white placeholder-white placeholder-opacity-60 rounded-xl focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50">
                            <button onclick="addEnquiry()" class="bg-white text-purple-700 px-6 py-3 rounded-xl font-semibold hover:bg-opacity-90 transition-all shadow-lg">
                                Process with NLP
                            </button>
                        </div>

                        <!-- Enquiries List -->
                        <div id="enquiries-list" class="space-y-4">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Chatbot Tab -->
                <div id="content-chatbot" class="tab-content hidden">
                    <div class="glass-effect rounded-2xl p-6 slide-up-animation" style="min-height: 600px; display: flex; flex-direction: column;">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-white">Smart AI Chatbot</h2>
                            <button onclick="resetChat()" class="bg-white text-purple-700 px-4 py-2 rounded-xl font-semibold text-sm hover:bg-opacity-90 transition-all">
                                Reset Chat
                            </button>
                        </div>

                        <!-- Quick Suggestions -->
                        <div class="flex flex-wrap gap-2 mb-4" id="quick-suggestions">
                            <button onclick="sendSuggestion('Show me laptops')" class="suggestion-btn">Show me laptops</button>
                            <button onclick="sendSuggestion('Budget smartphones')" class="suggestion-btn">Budget smartphones</button>
                            <button onclick="sendSuggestion('Wireless headphones')" class="suggestion-btn">Wireless headphones</button>
                            <button onclick="sendSuggestion('Smart watches')" class="suggestion-btn">Smart watches</button>
                        </div>

                        <!-- Chat Messages -->
                        <div class="flex-1 chat-container bg-white bg-opacity-10 rounded-xl p-4 border border-white border-opacity-20 mb-4" id="chat-messages">
                            <!-- Populated by JavaScript -->
                        </div>

                        <!-- Chat Input -->
                        <div class="flex space-x-2">
                            <input type="text" id="chat-input" placeholder="Ask me anything about products..." class="flex-1 px-4 py-3 bg-white bg-opacity-20 border border-white border-opacity-30 text-white placeholder-white placeholder-opacity-60 rounded-xl chat-input" onkeypress="handleChatKeyPress(event)">
                            <button onclick="sendMessage()" id="send-btn" class="bg-white text-purple-700 px-6 py-3 rounded-xl hover:bg-opacity-90 transition-all flex items-center space-x-2 font-bold shadow-lg">
                                <svg class="icon" style="width: 20px; height: 20px;">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                        <p class="text-white text-opacity-70 text-xs mt-2 text-center">
                            Try: "show me gaming laptops", "best budget phone", "compare headphones"
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
function fetchTotalEnquiries() {
    fetch('/get_total_enquiries')
        .then(response => response.json())
        .then(data => {
            document.getElementById('stat-total').textContent = data.total;
        });
}

// Fetch once when the page loads
fetchTotalEnquiries();
</script>

<script>
function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });

    // Remove "active" class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'bg-white', 'text-purple-700');
        btn.classList.add('text-white', 'bg-transparent');
    });

    // Show selected tab content
    const activeContent = document.getElementById(`content-${tabName}`);
    if (activeContent) activeContent.classList.remove('hidden');

    // Highlight active tab button
    const activeButton = document.getElementById(`tab-${tabName}`);
    if (activeButton) {
        activeButton.classList.add('active', 'bg-white', 'text-purple-700');
        activeButton.classList.remove('text-white', 'bg-transparent');
    }
}
</script>

    <script>


        // Global State
       // ------------------------
// Global State
// ------------------------
let state = {
    stats: {
        totalEnquiries: 247,
        matched: 198,
        responded: 186,
        conversions: 42
    },
    platformStats: {
        'Google Ads': 45,
        'Twitter/X': 62,
        'Facebook': 78,
        'Alexa': 62
    },
    enquiries: [
        { id: 1, platform: 'Twitter', query: 'best budget smartphone under $15,000', status: 'matched', product: 'Samsung Galaxy A54', confidence: 92, time: '2m ago', response: 'Check out the Galaxy A54! Great value at $449. ðŸ“±' },
        { id: 2, platform: 'Google Ads', query: 'laptop for gaming under 1000', status: 'matched', product: 'ASUS ROG Strix G15', confidence: 88, time: '5m ago', response: 'ASUS ROG Strix is perfect for gaming at $999! ðŸŽ®' },
        { id: 3, platform: 'Alexa', query: 'wireless headphones with noise cancellation', status: 'pending', product: null, confidence: 0, time: '8m ago', response: null },
        { id: 4, platform: 'Facebook', query: 'cheap running shoes', status: 'responded', product: 'Nike Revolution 6', confidence: 85, time: '12m ago', response: 'Nike Revolution 6 - $65. Great for running! ðŸ‘Ÿ' },
    ],
    chatMessages: [],
    lastRecommendation: null,
    isAnalyzing: false
};

// ------------------------
// Product Catalog
// ------------------------
const productCatalog = {
    'smartphone': { name: 'Samsung Galaxy A54', price: '$449', keywords: ['phone', 'smartphone', 'mobile', 'android', 'samsung', 'galaxy'] },
    'laptop': { name: 'ASUS ROG Strix G15', price: '$999', keywords: ['laptop', 'computer', 'gaming', 'notebook', 'pc', 'asus'] },
    'headphones': { name: 'Sony WH-1000XM5', price: '$349', keywords: ['headphones', 'earphones', 'audio', 'noise cancellation', 'wireless', 'sony'] },
    'shoes': { name: 'Nike Revolution 6', price: '$65', keywords: ['shoes', 'running', 'sneakers', 'footwear', 'nike', 'trainers'] },
    'tablet': { name: 'iPad Air M2', price: '$599', keywords: ['tablet', 'ipad', 'device', 'apple'] },
    'watch': { name: 'Apple Watch SE', price: '$249', keywords: ['watch', 'smartwatch', 'wearable', 'apple', 'fitness'] },
    'camera': { name: 'Canon EOS R50', price: '$679', keywords: ['camera', 'photography', 'dslr', 'canon', 'mirrorless'] }
};


document.addEventListener('DOMContentLoaded', function() {
            createBubbles();
            renderDashboard();
            renderEnquiries();
            initializeChat();
        });

        // Create Floating Bubbles
        function createBubbles() {
            const container = document.getElementById('bubbles-container');
            for (let i = 0; i < 15; i++) {
                const bubble = document.createElement('div');
                bubble.className = 'floating-bubble';
                bubble.style.left = `${Math.random() * 100}%`;
                bubble.style.width = `${Math.random() * 100 + 50}px`;
                bubble.style.height = bubble.style.width;
                bubble.style.animationDuration = `${Math.random() * 10 + 15}s`;
                bubble.style.animationDelay = `${Math.random() * 5}s`;
                container.appendChild(bubble);
            }
        }

        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Render Dashboard
        function renderDashboard() {
            document.getElementById('stat-total').textContent = state.stats.totalEnquiries;
            document.getElementById('stat-matched').textContent = state.stats.matched;
            document.getElementById('stat-responded').textContent = state.stats.responded;
            document.getElementById('stat-conversions').textContent = state.stats.conversions;

            const platformStatsHtml = Object.entries(state.platformStats).map(([platform, count]) => `
                <div class="bg-white bg-opacity-10 backdrop-blur-lg border border-white border-opacity-20 rounded-xl p-5 text-center hover:bg-opacity-20 transition-all cursor-pointer transform hover:scale-105">
                    <p class="font-semibold text-white">${platform}</p>
                    <p class="text-4xl font-bold text-white mt-3">${count}</p>
                    <p class="text-xs text-white text-opacity-70 mt-2">enquiries today</p>
                </div>
            `).join('');
            
            document.getElementById('platform-stats').innerHTML = platformStatsHtml;
        }

        // NLP Matching Engine
        function matchQueryToProduct(query) {
            const lowerQuery = query.toLowerCase();
            let bestMatch = null;
            let highestScore = 0;

            Object.entries(productCatalog).forEach(([key, product]) => {
                let score = 0;
                product.keywords.forEach(keyword => {
                    if (lowerQuery.includes(keyword)) {
                        score += 30;
                    }
                });
                
                if (lowerQuery.includes('budget') || lowerQuery.includes('cheap') || lowerQuery.includes('under')) {
                    score += 10;
                }

                if (score > highestScore) {
                    highestScore = score;
                    bestMatch = product;
                }
            });

            return {
                product: bestMatch,
                confidence: Math.min(highestScore, 95)
            };
        }

        // Generate Auto Response
        function generateAutoResponse(product, query) {
            const responses = [
                `Check out the ${product.name}! Perfect for your needs at ${product.price}. ðŸŽ¯`,
                `I recommend the ${product.name} - ${product.price}. Great choice! âœ¨`,
                `${product.name} matches your requirements! Available for ${product.price}. ðŸ”¥`,
                `Perfect match: ${product.name} at ${product.price}. Want more details? ðŸ’Ž`
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // Render Enquiries
        function renderEnquiries() {
            const enquiriesHtml = state.enquiries.map(enquiry => {
                let statusClass = '';
                let statusText = '';
                
                if (enquiry.status === 'matched') {
                    statusClass = 'status-matched';
                    statusText = 'MATCHED';
                } else if (enquiry.status === 'responded') {
                    statusClass = 'status-responded';
                    statusText = 'RESPONDED';
                } else {
                    statusClass = 'status-pending';
                    statusText = 'PENDING';
                }

                return `
                    <div class="bg-white bg-opacity-10 backdrop-blur-lg border border-white border-opacity-20 rounded-xl p-5 hover:bg-opacity-15 transition-all">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-3">
                                    <span class="bg-white text-purple-700 px-4 py-1 rounded-full text-xs font-bold">${enquiry.platform}</span>
                                    <span class="text-white text-opacity-70 text-xs">${enquiry.time}</span>
                                </div>
                                <p class="text-white font-medium mb-3 text-lg">${enquiry.query}</p>
                                ${enquiry.product ? `
                                    <div class="mb-3">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="text-sm text-white text-opacity-80">Matched:</span>
                                            <span class="text-sm font-bold text-white">${enquiry.product}</span>
                                            <span class="text-xs text-white text-opacity-60">(${enquiry.confidence}% confidence)</span>
                                        </div>
                                        ${enquiry.response ? `<p class="text-sm text-white text-opacity-80 bg-white bg-opacity-5 p-3 rounded-lg">${enquiry.response}</p>` : ''}
                                    </div>
                                ` : ''}
                                ${enquiry.status === 'pending' ? `
                                    <button onclick="respondToEnquiry(${enquiry.id})" class="mt-2 bg-yellow-400 text-purple-900 px-4 py-2 rounded-lg font-semibold text-sm hover:bg-yellow-300 transition-all">
                                        Run NLP Match
                                    </button>
                                ` : ''}
                            </div>
                            <div>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('enquiries-list').innerHTML = enquiriesHtml;
        }

        // Toggle Add Form
        function toggleAddForm() {
            const form = document.getElementById('add-form');
            const btn = document.getElementById('add-enquiry-btn');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.innerHTML = `
                    <svg class="icon" style="width: 18px; height: 18px;">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    <span>Cancel</span>
                `;
            } else {
                form.classList.add('hidden');
                btn.innerHTML = `
                    <svg class="icon" style="width: 18px; height: 18px;">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>Add Enquiry</span>
                `;
            }
        }

        // Add New Enquiry
        function addEnquiry() {
            const platform = document.getElementById('new-platform').value;
            const query = document.getElementById('new-query').value.trim();

            if (!query) return;

            const match = matchQueryToProduct(query);
            const newId = Math.max(...state.enquiries.map(e => e.id)) + 1;

            const newEnquiry = {
                id: newId,
                platform: platform,
                query: query,
                status: match.confidence > 50 ? 'matched' : 'pending',
                product: match.confidence > 50 ? match.product.name : null,
                confidence: match.confidence,
                time: 'Just now',
                response: match.confidence > 50 ? generateAutoResponse(match.product, query) : null
            };

            state.enquiries.unshift(newEnquiry);
            
            state.stats.totalEnquiries++;
            if (match.confidence > 50) {
                state.stats.matched++;
                state.stats.responded++;
            }

            state.platformStats[platform]++;

            renderDashboard();
            renderEnquiries();
            
            document.getElementById('new-query').value = '';
            toggleAddForm();
        }

        // Respond to Pending Enquiry
        function respondToEnquiry(id) {
            const enquiry = state.enquiries.find(e => e.id === id);
            if (!enquiry || enquiry.status !== 'pending') return;

            const match = matchQueryToProduct(enquiry.query);
            
            enquiry.status = match.confidence > 50 ? 'responded' : 'pending';
            enquiry.product = match.confidence > 50 ? match.product.name : null;
            enquiry.confidence = match.confidence;
            enquiry.response = match.confidence > 50 ? generateAutoResponse(match.product, enquiry.query) : 'No suitable match found';

            if (match.confidence > 50) {
                state.stats.responded++;
                state.stats.matched++;
            }

            renderDashboard();
            renderEnquiries();
        }

// ------------------------
// Initialize Chat
// ------------------------
function initializeChat() {
    state.chatMessages = [{
        type: 'bot',
        text: 'ðŸ‘‹ Hi! I\'m your AI Shopping Assistant. I can help you find products based on your needs. Try asking me about:\n\nâ€¢ Smartphones\nâ€¢ Laptops\nâ€¢ Headphones\nâ€¢ Watches\nâ€¢ Cameras\nâ€¢ Tablets\nâ€¢ Shoes\n\nWhat are you looking for today?',
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    }];
    renderChatMessages();
}

// ------------------------
// Render Chat Messages
// ------------------------
function renderChatMessages() {
    const chatContainer = document.getElementById('chat-messages');
    const messagesHtml = state.chatMessages.map(msg => {
        const alignment = msg.type === 'user' ? 'justify-end' : 'justify-start';
        const bgClass = msg.type === 'user' 
            ? 'bg-white text-purple-700 font-semibold shadow-lg' 
            : 'bg-white bg-opacity-20 border border-white border-opacity-30 text-white';
        const timeClass = msg.type === 'user' ? 'text-purple-500' : 'text-white text-opacity-60';

        return `
            <div class="flex ${alignment} chat-message">
                <div class="max-w-xs md:max-w-md px-4 py-3 rounded-xl ${bgClass}">
                    <p class="text-sm whitespace-pre-line">${msg.text}</p>
                    <p class="text-xs mt-1 ${timeClass}">${msg.time}</p>
                </div>
            </div>
        `;
    }).join('');

    chatContainer.innerHTML = messagesHtml;
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// ------------------------
// Match Query to Product
// ------------------------
function matchQueryToProduct(query) {
    const lowerQuery = query.toLowerCase();
    let bestMatch = null;
    let highestScore = 0;

    Object.entries(productCatalog).forEach(([key, product]) => {
        let score = 0;
        product.keywords.forEach(keyword => {
            if (lowerQuery.includes(keyword)) score += 30;
        });
        if (lowerQuery.includes('budget') || lowerQuery.includes('cheap') || lowerQuery.includes('under')) score += 10;
        if (score > highestScore) {
            highestScore = score;
            bestMatch = product;
        }
    });

    return { product: bestMatch, confidence: Math.min(highestScore, 95) };
}

// ------------------------
// Generate Chatbot Response
// ------------------------
async function generateChatbotResponse(query, match) {
    try {
        // Call backend
        const res = await fetch('/get_response', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: query })
        });
        const data = await res.json();
        return data.reply || 'ðŸ¤– Sorry, I could not process your request.';
    } catch (e) {
        // fallback to dummy data
        if (match.product && match.confidence > 50) {
            return `ðŸŽ¯ I recommend **${match.product.name}** (${match.product.price}) - confidence ${match.confidence}%`;
        }
        return `ðŸ” I couldn't find an exact match, but I can suggest some products based on your query.`;
    }
}

// ------------------------
// Send Message
// ------------------------
async function sendMessage() {
    const input = document.getElementById('chat-input');
    const query = input.value.trim();
    if (!query || state.isAnalyzing) return;

    const userMessage = {
        type: 'user',
        text: query,
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    };
    state.chatMessages.push(userMessage);
    renderChatMessages();
    input.value = '';
    state.isAnalyzing = true;

    // Disable buttons while analyzing
    document.querySelectorAll('.suggestion-btn').forEach(btn => btn.disabled = true);
    document.getElementById('send-btn').disabled = true;

    // Add analyzing message
    state.chatMessages.push({
        type: 'bot',
        text: 'ðŸ”„ Analyzing your request...',
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    });
    renderChatMessages();

    // Wait 1s to simulate processing
    setTimeout(async () => {
        state.chatMessages.pop(); // remove analyzing
        const match = matchQueryToProduct(query);
        const botReply = await generateChatbotResponse(query, match);

        if (match.product && match.confidence > 50) state.lastRecommendation = match.product;

        state.chatMessages.push({
            type: 'bot',
            text: botReply,
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        });

        renderChatMessages();
        state.isAnalyzing = false;
        document.querySelectorAll('.suggestion-btn').forEach(btn => btn.disabled = false);
        document.getElementById('send-btn').disabled = false;
    }, 1000 + Math.random() * 500);
}

// ------------------------
// Suggestion buttons
// ------------------------
function sendSuggestion(text) {
    if (state.isAnalyzing) return;
    document.getElementById('chat-input').value = text;
    sendMessage();
}

// ------------------------
// Reset Chat
// ------------------------
window.resetChat = function() {
    state.chatMessages = [];
    state.lastRecommendation = null;
    state.isAnalyzing = false;
    initializeChat();
};

// ------------------------
// Handle Enter key
// ------------------------
function handleChatKeyPress(event) {
    if (event.key === 'Enter' && !state.isAnalyzing) sendMessage();
}

// ------------------------
// Initialize
// ------------------------
document.addEventListener('DOMContentLoaded', function() {
    initializeChat();
});

</script>

</body>
</html>